name: codex-request-review

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review, labeled, synchronize]

permissions:
  issues: write
  pull-requests: write
  statuses: write

concurrency:
  group: codex-request-review-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  request-codex-review:
    if: >
      github.event.pull_request.draft == false &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Debug status (PR 11 only)
        if: ${{ github.event.pull_request.number == 11 }}
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.pull_request.head.sha;

            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: "success",
              context: "codex-request-review",
              description: "workflow started",
            });

      - name: Comment @codex review (once)
        id: token_comment
        if: ${{ secrets.CODEX_REVIEW_TOKEN != '' }}
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CODEX_REVIEW_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const requiredLabel = "automerge";

            try {
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber,
              });

              const labels = (pr.labels || []).map((l) => l.name);
              if (!labels.includes(requiredLabel)) {
                core.info(`Skipping: PR missing label '${requiredLabel}'.`);
                core.setOutput("commented", "false");
                core.setOutput("skipped", "true");
                return;
              }

              if (
                context.payload.action === "labeled" &&
                context.payload.label?.name !== requiredLabel
              ) {
                core.info(
                  `Skipping: labeled '${context.payload.label?.name}', waiting for '${requiredLabel}'.`
                );
                core.setOutput("commented", "false");
                core.setOutput("skipped", "true");
                return;
              }

              const { data: comments } = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: prNumber,
                per_page: 100,
              });

              const alreadyRequested = comments.some((c) =>
                (c.body || "").includes("@codex review")
              );
              if (alreadyRequested) {
                core.info("Skipping: @codex review already requested.");
                core.setOutput("commented", "false");
                core.setOutput("skipped", "true");
                return;
              }

              const body = [
                "@codex review",
                "",
                "Please follow `AGENTS.md` review guidelines.",
                "",
                "If you are able, include this block verbatim at the end of your response:",
                "````",
                "CODEX_AUTOMERGE_V1",
                "RESULT: PASS|FAIL",
                "P0_COUNT: <int>",
                "P1_COUNT: <int>",
                "AUTOMERGE: ENABLE|SKIP",
                "````",
              ].join("\n");

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });

              core.setOutput("commented", "true");
              core.setOutput("skipped", "false");
            } catch (error) {
              const message = String(error?.message || error);
              core.warning(
                `Failed to post @codex review via CODEX_REVIEW_TOKEN: ${message}`
              );
              core.setOutput("commented", "false");
              core.setOutput("skipped", "false");
              core.setOutput("error", message);
            }

      - name: Skip (missing CODEX_REVIEW_TOKEN)
        if: ${{ secrets.CODEX_REVIEW_TOKEN == '' }}
        run: |
          echo "CODEX_REVIEW_TOKEN is not set; skipping automatic @codex review comment (connector usually ignores github-actions[bot])."

      - name: Diagnostic (CODEX_REVIEW_TOKEN failed)
        if: >
          secrets.CODEX_REVIEW_TOKEN != '' &&
          steps.token_comment.outputs.commented != 'true' &&
          steps.token_comment.outputs.skipped != 'true' &&
          steps.token_comment.outputs.error != ''
        uses: actions/github-script@v7
        env:
          TOKEN_ERROR: ${{ steps.token_comment.outputs.error }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            const msg = [
              "WARNING: `codex-request-review` could not post `@codex review` using `CODEX_REVIEW_TOKEN`.",
              "",
              "This usually means the token is missing required permissions for PR issue comments.",
              "",
              "Required (fine-grained PAT):",
              "- Repository access: this repo",
              "- Permissions: **Issues: Read and write**",
              "",
              `Error: ${process.env.TOKEN_ERROR}`,
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: msg,
            });
