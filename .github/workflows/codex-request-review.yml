name: codex-request-review

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review, labeled]

permissions:
  issues: write
  pull-requests: write

concurrency:
  group: codex-request-review-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  request-codex-review:
    if: >
      github.event.pull_request.draft == false &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      contains(github.event.pull_request.labels.*.name, 'automerge') &&
      (github.event.action != 'labeled' || github.event.label.name == 'automerge')
    runs-on: ubuntu-latest
    steps:
      - name: Comment @codex review (once)
        if: ${{ secrets.CODEX_REVIEW_TOKEN != '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CODEX_REVIEW_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const alreadyRequested = comments.some((c) =>
              (c.body || "").includes("@codex review")
            );
            if (alreadyRequested) {
              core.info("Skipping: @codex review already requested.");
              return;
            }

            const body = [
              "@codex review",
              "",
              "Please follow `AGENTS.md` review guidelines.",
              "",
              "If you are able, include this block verbatim at the end of your response:",
              "```",
              "CODEX_AUTOMERGE_V1",
              "RESULT: PASS|FAIL",
              "P0_COUNT: <int>",
              "P1_COUNT: <int>",
              "AUTOMERGE: ENABLE|SKIP",
              "```",
            ].join("\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body,
            });

      - name: Skip (missing CODEX_REVIEW_TOKEN)
        if: ${{ secrets.CODEX_REVIEW_TOKEN == '' }}
        run: |
          echo "CODEX_REVIEW_TOKEN is not set; skipping automatic @codex review comment (connector usually ignores github-actions[bot])."
